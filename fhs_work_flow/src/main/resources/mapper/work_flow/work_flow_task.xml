<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.fhs.workflow.dao.WorkFlowTaskDAO">
	<select id="findNeedComplateTask" parameterType="java.util.Map"
		resultType="map">
		SELECT
		`ID_`,
		`REV_`,
		`EXECUTION_ID_`,
		`PROC_INST_ID_`,
		`PROC_DEF_ID_`,
		`NAME_`,
		`PARENT_TASK_ID_`,
		`DESCRIPTION_`,
		`TASK_DEF_KEY_`,
		`OWNER_`,
		`ASSIGNEE_`,
		`DELEGATION_`,
		`PRIORITY_`,
		DATE_FORMAT(`CREATE_TIME_`,'%Y-%m-%d %H:%i:%s') CREATE_TIME_,
		`DUE_DATE_`,
		`CATEGORY_`,
		`SUSPENSION_STATE_`,
		`TENANT_ID_`,
		`FORM_KEY_` ,
		`id`,
		`title`,
		`creator`,
		`creator_id`,
		DATE_FORMAT(`create_datetime`,'%Y-%m-%d %H:%i:%s') `create_datetime`,
		`work_flow_type_id`,
		`work_flow_id`,
		`process_instance_id`,
		`form_id`,
		`form_key`,
		`extend_json`
		FROM
		`act_ru_task` t LEFT JOIN
		t_work_flow_instance i
		ON
		t.PROC_INST_ID_ = i.process_instance_id
		WHERE 1
		= 1
		<include refid="sqlWhere" />
		ORDER BY CREATE_TIME_ DESC
		<if test="start!= null and end != null">
			LIMIT ${start}, ${end}
		</if>
	</select>

	<select id="findNeedComplateTaskCount" parameterType="map" resultType="java.lang.Integer">
		SELECT
		 COUNT(1)
		FROM
		`act_ru_task` t LEFT JOIN
		t_work_flow_instance i
		ON
		t.PROC_INST_ID_ = i.process_instance_id
		WHERE 1
		= 1
		<include refid="sqlWhere" />
	</select>

	<sql id="sqlWhere">
		<if test="creator!=null and creator !='' ">
			AND creator = #{creator}
		</if>
		<if test="title !=null and title !='' ">
			AND title LIKE '%${title}%'
		</if>
		<if test="taskTime !=null and taskTime !='' ">
			AND  to_days(`CREATE_TIME_`) = to_days('${taskTime}')
		</if>
		<if test="instanceTime !=null and instanceTime !='' ">
			AND  to_days(`create_datetime`) = to_days('${instanceTime}')
		</if>
		<if test="userLoginName !=null and userLoginName !='' ">
			AND  `ASSIGNEE_` = #{userLoginName}
		</if>
	</sql>


	<select id="findNeedClaimTask" parameterType="map" resultType="map">
		SELECT DISTINCT
		RES1.`ID_`,
		RES1.`REV_`,
		RES1.`EXECUTION_ID_`,
		RES1.`PROC_INST_ID_`,
		RES1.`PROC_DEF_ID_`,
		RES1.`NAME_`,
		RES1.`PARENT_TASK_ID_`,
		RES1.`DESCRIPTION_`,
		RES1.`TASK_DEF_KEY_`,
		RES1.`OWNER_`,
		RES1.`ASSIGNEE_`,
		RES1.`DELEGATION_`,
		RES1.`PRIORITY_`,
		DATE_FORMAT(RES1.`CREATE_TIME_`,'%Y-%m-%d %H:%i:%s') CREATE_TIME_,
		RES1.`DUE_DATE_`,
		RES1.`CATEGORY_`,
		RES1.`SUSPENSION_STATE_`,
		RES1.`TENANT_ID_`,
		RES1.`FORM_KEY_` ,
		instance.`id`,
		instance.`title`,
		instance.`creator`,
		instance.`creator_id`,
		DATE_FORMAT(instance.`create_datetime`,'%Y-%m-%d %H:%i:%s') `create_datetime`,
		instance.`work_flow_type_id`,
		instance.`work_flow_id`,
		instance.`process_instance_id`,
		instance.`form_id`,
		instance.`form_key`,
		instance.`extend_json`
		
		<include refid="needClaimWhere"></include>
		ORDER BY RES1.CREATE_TIME_ DESC
		<if test="start!= null and end != null">
			LIMIT ${start}, ${end}
		</if>
	</select>

	<select id="findNeedClaimTaskCount" parameterType="map"
		resultType="int">
		SELECT DISTINCT
		COUNT(1)
		<include refid="needClaimWhere"></include>
	</select>


	<sql id="needClaimWhere">
		FROM
		ACT_RU_TASK RES1 INNER JOIN ACT_RE_PROCDEF D ON RES1.PROC_DEF_ID_ =
		D.ID_ INNER
		JOIN ACT_RU_VARIABLE V ON
		V.PROC_INST_ID_=RES1.PROC_INST_ID_
		LEFT JOIN ACT_RU_IDENTITYLINK I ON
		I.TASK_ID_ = RES1.ID_ LEFT JOIN
		t_work_flow_instance instance
		ON
		RES1.PROC_INST_ID_ = instance.process_instance_id
		WHERE
		RES1.ASSIGNEE_ IS NULL
		AND I.TYPE_ = 'candidate' AND (
		I.USER_ID_ =
		#{userLoginName}
		OR I.GROUP_ID_ IN (
		SELECT
		ur.`role_id`
		FROM
		t_admin_user U
		LEFT JOIN
		t_admin_role_user_rela ur ON U.user_id = ur.`user_id`
		WHERE
		U.user_login_name
		= #{userLoginName}
		)
		)
	</sql>
</mapper>