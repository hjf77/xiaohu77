<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>处理</title>
    <style>
        #claimTask {
            display: none;
        }
    </style>

</head>
<body class="panel panel-default">
<div id="tt" class="easyui-tabs">
    <div title="详情" style="padding:20px;">
        <table id="details">
            <iframe src="" id="formDetailFrame" width="100%" height="100%" frameborder="0"
                    class="layadmin-iframe"></iframe>
        </table>
    </div>
    <div title="审批历史" data-options="" style="padding:20px;">
        <table id="approval_history"></table>
    </div>
    <div title="流程图" data-options="" style="padding:20px;">
        <table id="flow_chat">
            <img id="flowImnage">
        </table>
    </div>
</div>


<%
     if(nvl(parameter.isView,'false')=='false'){
  %>

<div id="approval_operation">
    <div class="infoGroup">
        <legend>审批操作</legend>
    </div>
    <div class="fitem">
        <div class="bigLabelDiv"><label>备注:</label></div>
        <div class="bigContent"><textarea datatype="empty|*" nullmsg="备注不能为空" errormsg="备注输入了错误的格式"
                                          class="form_textarea "
                                          id="remark" name="remark" placeholder="请填写备注" prompt="请选择备注"></textarea></div>
    </div>
    <div class="fitem">
        <div class="bigLabelDiv"><label>抄送人:</label></div>
        <div class="bigContent" id="ccUserDiv" style="padding-top: 8px;padding-left: 10px;"></div>
    </div>
    <div class="handle-button">
        <!-- 待认领状态下只显示认领按钮后才会有其他操作 -->
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="claimTask"
           onclick="claimTask()">认领OK</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="complateTask" onclick="complateTask()">同意OK</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="ccTo" onclick="addCCTo()">抄送</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="delegate" onclick="delegate()">转办</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="backTask" onclick="backTask()">驳回OK</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="backTask_node"
           onclick="backTask_node()">驳回到指定操作OK</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="preAdd" onclick="preAdd()">前加签</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="afterAdd" onclick="afterAdd()">后加签</a>
        <!-- 已办状态但还未到下一步操作 -->
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="withdraw" onclick="withdraw()">撤回OK</a>
        <a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="revoke" onclick="revoke()">撤销申请OK</a>
    </div>
</div>
<div id="addOrUpdateDialog2" class="easyui-dialog" title="回退节点"
     data-options="iconCls:'icon-save'" closed="true"
     style="width: 45%; height: 68%; padding: 10px"
     >
</div>
<%
   }
%>
<%
if(nvl(parameter.isView,'false') == 'true'){
%>
<div class="fitem">
    <div class="bigLabelDiv"><label>抄送人:</label></div>
    <div class="bigContent" id="ccUserDiv" style="padding-top: 8px;padding-left: 10px;"></div>
</div>
<%}%>
<%
if(nvl(parameter.isView,'false') == 'true' && nvl(parameter.isTaskHistory,'false') == 'true'){
%>

<center><a href="javascript:void(0)" class="easyui-linkbutton" plain="true" id="withdraw" onclick="withdraw()">撤回OK</a></center>
<%}%>
</body>
<script>
    $("#dlg-buttons").hide();
    var taskId = "${parameter.taskId!}";
    var instanceId = "${parameter.instanceId}"
    var formUrl = null;
    $(function () {
        //我是申请人，显示撤销申请按钮
        $.ajax({
            async: false, //同步
            type: 'post',
            url: '${basePath}ms/flow_instance/isRevokeApply?instanceId=' + instanceId,
            success: function (res) {
                if (res.code == 200) {
                    if (res.data == false) {
                        $("#revoke").hide();
                    }
                }
            }
        })

        loadInstance();

        <%
        if(nvl(parameter.isView,'false')=='false'){
        %>
            //回退节点为0
            $.ajax({
                async: false, //同步
                type: 'post',
                url: '${basePath}ms/myWorks/findBackAvtivity?taskId=' + taskId,
                success: function (res) {
                    if (res.code == 200) {
                        if (res.data.length == 0) {
                            $("#ccTo").hide();
                            $("#backTask").hide();
                            $("#backTask_node").hide();
                            $("#delegate").hide();
                            $("#preAdd").hide();
                            $("#afterAdd").hide();
                            $("#withdraw").hide();
                            $("#complateTask").hide();
                            $('#formDetailFrame').attr('src',formUrl + '&isEdit=true&taskId=' + taskId);
                        }else{
                            $('#formDetailFrame').attr('src',formUrl + '&isView=true');
                        }
                    }
                }
            })

            isClaimTask();

        <%}%>
        <%
        if(nvl(parameter.isView,'false') == 'true'){
        %>
            $('#formDetailFrame').attr('src',formUrl + '&isView=true');
        <%}%>
        addChildListener();
    })

    //添加监听器
    function addChildListener(){
        window.addEventListener('message',function(event){
            //
            if(event.data.type=='setHeight'){
                if($('#formDetailFrame').height() >  event.data.height){
                    $('#formDetailFrame').height(new Number(event.data.height) + 30);
                }
            }
            else if(event.data.type=='reSubmit'){
                if(event.data.isSuccess){
                    Ealert('操作成功');
                    closeDialog();
                    reload();
                }
                else{
                    EalertE(event.data.message);
                }
            }

        },false);
    }

    //是否认领
    function isClaimTask() {
        $.ajax({
            type: 'post',
            url: '${basePath}ms/myWorks/isClaimTask?taskId=' + taskId,
            success: function (res) {
                if (res.data) {
                    $("#claimTask").show();
                }
            }
        })
    }

    function loadInstance(){
        //获取表单
        $.ajax({
            async: false, //同步
            url: '${basePath}ms/myWorks/findInstanceById?instanceId=' + instanceId,
            dataType:'json',
            success: function (res) {
                if (res.code == 200) {
                    formUrl = res.data.formUrl;
                    $('#ccUserDiv').text(res.data.transMap.ccToUserUserName);
                }
            }
        })
    }



    $('#tt').tabs({
        onSelect: function (title, index) {
            $("#approval_operation").hide();
            if (index == 0) {
                $("#approval_operation").show();
            }
            if (index == 1) {
                $('#approval_history').datagrid({
                    url: '${basePath}ms/flowTaskHistory/getApprovalRecord?instanceId=' + instanceId,
                    pagination: false,
                    columns: [[
                        {field: 'taskName', title: '任务名称', width: '30%', align: 'center'},
                        {field: 'createTime', title: '任务创建时间', width: '16%', align: 'center'},
                        {field: 'taskFinishTime', title: '处理时间', width: '16%', align: 'center'},
                        {field: 'transMap.userName', title: '处理人', width: '10%', align: 'center'},
                        {field: 'transMap.useStatusName', title: '处理状态', width: '10%', align: 'center'},
                        {field: 'remark', title: '备注/意见', width: '20%', align: 'center'},
                    ]]
                });

            }
            if (index == 2) {
                $("#flowImnage").attr("src", "${basePath}ms/myWorks/getWorkFlowImg?instanceId=" + instanceId)
            }
        }
    })

    //驳回
    function backTask() {
        $.ajax({
            type: 'post',
            url: '${basePath}ms/myWorks/backTask?taskId=' + taskId,
            success: function (res) {
                if (res.code == 200) {
                    Ealert("操作成功");
                    closeDialog();
                    reload();
                } else {
                    EalertE(res.message);
                }
            }
        })
    }

    //驳回指定节点
    function backTask_node() {
        openDialog2('${basePath}b/page-ms-flow/node?taskId=' + taskId, '可回退节点');
    }


    //抄送
    function addCCTo() {
        openDialog2('${basePath}b/page-ms-flow/cc_to?instanceId=' + instanceId, '添加抄送人');
    }

    // 打开dialog2
    function openDialog2(url, title) {
        $('#addOrUpdateDialog2').load(url, function () {
            $('#addOrUpdateDialog2').dialog('open').dialog('setTitle', title);
            $.parser.parse($('#addOrUpdateDialog2'));
        });
    }

    //签收/认领
    function claimTask() {
        $.ajax({
            type: 'post',
            url: '${basePath}ms/myWorks/claimTask?taskId=' + taskId,
            success: function (res) {
                if (res.code == 200) {
                    Ealert("操作成功");
                    reload();
                } else {
                    EalertE(res.message);
                }

            }
        })

    }

    //同意
    function complateTask() {
        $.ajax({
            type: 'post',
            url: '${basePath}ms/myWorks/complateTask',
            data: {taskId: taskId, remark: $("#remark").val()},
            success: function (res) {
                if (res.code == 200) {
                    Ealert("操作成功");
                    closeDialog();
                    reload();
                } else {
                    EalertE(res.message);
                }
            }
        })
    }

    //撤回
    function withdraw() {
        $.ajax({
            type: 'post',
            url: '${basePath}ms/myWorks/withdraw?taskId=' + taskId,
            success: function (res) {
                if (res.code == 200) {
                    Ealert("操作成功");
                    closeDialog();
                    reload();
                } else {
                    EalertE(res.message);
                }
            }
        })
    }

    //撤销
    function revoke() {
        $.ajax({
            type: 'post',
            url: '${basePath}ms/myWorks/revoke?taskId=' + taskId,
            success: function (res) {
                if (res.code == 200) {
                    Ealert("操作成功");
                    closeDialog();
                    reload();
                } else {
                    EalertE(res.message);
                }
            }
        })
    }

    // 关闭dialog2
    function closeDialog2() {
        $('#addOrUpdateDialog2').dialog('close');
    }
</script>

</html>