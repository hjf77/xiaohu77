<script type="text/javascript">
    <!--
    //var tid = "";
    var listenerId = "";
    var fieldsEditCount = 0;

    $(function () {
        $('#task-properties-accordion').accordion({
            onSelect: function (title, index) {
                if (title == '通用') {
                    var pp = $('#task-properties-accordion').accordion('getSelected');
                    if (pp) {
                        pp.panel('refresh', '${basePath}/b/page-work_flow/taskGeneral');
                    }
                } else if (title == '多实例') {
                    var pp = $('#task-properties-accordion').accordion('getSelected');
                    if (pp) {
                        pp.panel('refresh', '${basePath}/b/page-work_flow/taskMultiInstance');
                    }
                }
            }
        });
        _listener_win = $('#listener-win').window({
            //href:'${basePath}/wf/procdef/procdef!forTaskListenerConfig.action',
            closed: true,
            //cache:false,
            draggable: false,
            collapsible: false,
            minimizable: false,
            maximizable: false,
            modal: true,
            shadow: true
        });
        _task_fields_dg = $('#task-Fields-list').datagrid({
            //title:"Listener",
            //url:'${basePath}/wf/procdef/procdef!search.action',//加载表格数据的URL
            singleSelect: true,
            width: 600,
            height: 300,
            iconCls: 'icon-edit',
            //fit:true,
            //idField:'id',
            //pagination:true,
            //pageSize:15,
            //pageNumber:1,
            //pageList:[10,15],
            rownumbers: true,
            //sortName:'id',
            //sortOrder:'asc',
            striped: true,
            toolbar: [{
                text: '新增',
                iconCls: 'icon-add',
                handler: function () {
                    if (fieldsEditCount > 0) {
                        $.messager.alert("error", "有可编辑的单元格，不能添加", 'error');
                        return;
                    }
                    $('#task-Fields-list').datagrid('appendRow', {
                        id: '',
                        fieldName: '',
                        type: '',
                        value: '',
                        action: ''
                    });
                    var index = $('#task-Fields-list').datagrid('getRows').length - 1;
                    $('#task-Fields-list').datagrid('beginEdit', index);
                }
            }],

            onDblClickRow: function (rowIndex, rowData) {
                editField(rowIndex);
            },

            onBeforeEdit: function (index, row) {
                row.editing = true;
                $(this).datagrid('refreshRow', index);
                fieldsEditCount++;
            },
            onAfterEdit: function (index, row) {
                var field = task.getField(row.id);
                if (field != null) {
                    field.name = row.fieldName;
                    field.value = row.value;
                    field.type = row.type;
                } else {
                    var newfield = new ESTDesigner.model.Field();
                    row.id = newfield.id;
                    newfield.name = row.fieldName;
                    newfield.value = row.value;
                    newfield.type = row.type;
                    task.fields.add(newfield);
                }
                row.editing = false;
                $(this).datagrid('refreshRow', index);
                fieldsEditCount--;
            },
            onCancelEdit: function (index, row) {
                row.editing = false;
                $(this).datagrid('refreshRow', index);
                fieldsEditCount--;
            }
        });

        $('#task-listeners-list').datagrid({
            title: "执行监听器",
            //url:'${basePath}/wf/procdef/procdef!search.action',//加载表格数据的URL
            singleSelect: true,
            //width:500,
            height: 300,
            idField: 'id',
            //pagination:true,
            //pageSize:15,
            //pageNumber:1,
            //pageList:[10,15],
            rownumbers: true,
            //sortName:'id',
            //sortOrder:'asc',
            striped: true,
            toolbar: [{
                text: '新增',
                iconCls: 'icon-add',
                handler: function () {
                    _listener_win.window('open');
                    //_listener_frame.src="";
                    _listener_win.window('refresh', '${basePath}/b/page-work_flow/executionListenerConfig');
                    //alert(_listener_frame.document.body.innerHTML);
                }
            }]
        });

        populateTaskProperites();
        //switchTaskCandidatesList($('#performerType').combobox('getValue'));
    });

    function cancelField(id) {
        _task_fields_dg.datagrid('cancelEdit', id);
    }

    function editField(id) {
        _task_fields_dg.datagrid('beginEdit', id);
    }

    function saveField(id) {
        _task_fields_dg.datagrid('endEdit', id);
    }

    function deleteField(index, id) {
        task.deleteField(id);
        _task_fields_dg.datagrid('deleteRow', index);
        refreshAllFields();
    }

    function refreshAllFields() {
        var rs = _task_fields_dg.datagrid('getRows');
        for (var i = 0; i < rs.length; i++) {
            var ri = _task_fields_dg.datagrid('getRowIndex', rs[i]);
            _task_fields_dg.datagrid('refreshRow', ri);
        }
    }

    function fieldsActionFormatter(value, rowData, rowIndex) {
        var id = rowIndex;
        var s = '<img onclick="saveField(' + id + ')" src="image/ok.png" title="' + "确定" + '" style="cursor:hand;"/>';
        var c = '<img onclick="cancelField(' + id + ')" src="image/cancel.png" title="' + "取消" + '" style="cursor:hand;"/>';
        var e = '<img onclick="editField(' + id + ')" src="image/modify.png" title="' + "修改" + '" style="cursor:hand;"/>';
        var d = '<img onclick="deleteField(' + id + ',\'' + rowData.id + '\')" src="image/delete.gif" title="' + "删除" + '" style="cursor:hand;"/>';
        if (rowData.editing)
            return s + '&nbsp;' + c;
        else
            return e + '&nbsp;' + d;
    }

    function listenerActionBt(value, rowData, rowIndex) {
        var id = rowData.id;
        var e = '<img onclick="editListener(\'' + id + '\')" src="image/edit.gif" title="' + "修改" + '" style="cursor:hand;"/>';
        var d = '<img onclick="deleteListener(\'' + id + '\')" src="image/delete.gif" title="' + "删除" + '" style="cursor:hand;"/>';
        return e + '&nbsp;' + d;
    }

    function editListener(id) {
        listenerId = id;
        _listener_win.window('open');
        _listener_win.window('refresh', '${basePath}/b/page-work_flow/executionListenerConfig');
    }

    function deleteListener(id) {
        task.deleteListener(id);
        loadTaskListeners();
    }

    function saveTaskProperties() {
        //alert(tid);
        saveTaskGeneral();
        if (typeof saveTaskMultiInstance == 'function')
            saveTaskMultiInstance();
        var r = saveTaskMainConfig();
        if (r)
            $.messager.alert('Info', '保存成功！', 'info');
    }

    function saveTaskMainConfig() {
        var type = $('input:radio[name="_type"]:checked').val();
        if (type == 'javaClass') {
            task._type = $('#javaClassType').val();
            task._javaClass = $('#serviceClass').val();
        } else if (type == 'expression') {
            task._type = $('#expressionType').val();
            task._expression = $('#_expression').val();
        } else if (type == 'delegateExpression') {
            task._type = $('#delegateExpressionType').val();
            task.delegateExpression = $('#delegateExpression').val();
        }
        task.resultVariable = $('#resultVariable').val();
        task.documentation = $('#documentation').val();
        return true;
    }

    function populateTaskProperites() {
        loadTaskMainConfig();
        loadTaskListeners();
    }

    function loadTaskMainConfig() {
        controlTaskTypeDisplay(task._type);
        if (task._type == 'javaClass') {
            $('#serviceClass').val(task._javaClass);
        } else if (task._type == 'expression') {
            $('#_expression').val(task._expression);
        } else if (task._type == 'delegateExpression') {
            $('#delegateExpression').val(task.delegateExpression);
        }
        $('#resultVariable').val(task.resultVariable);
        loadTaskFields();
        $('#documentation').val(task.documentation);
    }

    function loadTaskFields() {
        var fields = task.fields;
        var fields_grid_rows = [];
        for (var i = 0; i < fields.getSize(); i++) {
            var field = fields.get(i);
            var nfield = {
                id: field.id,
                fieldName: field.name,
                type: field.type,
                value: field.value,
                action: ''
            };
            fields_grid_rows[i] = nfield;
        }
        ;
        var field_grid_data = {
            total: fields.getSize(),
            rows: fields_grid_rows
        };
        $('#task-Fields-list').datagrid('loadData', field_grid_data);
    }

    function loadTaskListeners() {
        var listeners = task.listeners;
        var listener_grid_rows = [];
        //alert(listeners.getSize());
        for (var i = 0; i < listeners.getSize(); i++) {
            var listener = listeners.get(i);
            var nlistener = {
                id: listener.getId(),
                listenerImplimentation: listener.getServiceImplementation(),
                type: listener.serviceType,
                event: listener.event,
                fields: listener.getFieldsString(),
                action: ''
            };
            listener_grid_rows[i] = nlistener;
        }
        ;
        //alert(listener_grid_rows);
        var listener_grid_data = {
            total: listeners.getSize(),
            rows: listener_grid_rows
        };
        $('#task-listeners-list').datagrid('loadData', listener_grid_data);
    }

    function selectServiceTaskType(obj) {
        if (obj.checked) {
            controlTaskTypeDisplay(obj.value)
        }
    }

    function controlTaskTypeDisplay(t) {
        if (t == 'javaClass') {
            $('#serviceClassTr').show();
            $('#expressionTr').hide();
            $('#delegateExpressionTr').hide();
        } else if (t == 'expression') {
            $('#serviceClassTr').hide();
            $('#expressionTr').show();
            $('#delegateExpressionTr').hide();
        } else if (t == 'delegateExpression') {
            $('#serviceClassTr').hide();
            $('#expressionTr').hide();
            $('#delegateExpressionTr').show();
        }
    }

    //-->
</script>
<div id="task-properties-layout" class="easyui-layout" fit="true">
    <div id="task-properties-toolbar-panel" region="north" border="false" style="height:30px;background:#E1F0F2;">
        <a href="##" id="sb2" class="easyui-linkbutton" plain="true" iconCls="icon-save" onclick="saveTaskProperties()">保存</a>
    </div>
    <div id="task-properties-panel" region="center" border="true">
        <div id="task-properties-accordion" class="easyui-accordion" fit="true" border="false">
            <div id="general" title="通用" selected="true" class="properties-menu">

            </div>
            <div id="mainConfig" title="主要配置" class="properties-menu">
                <table id="main-properties">
                    <tr>
                        <td>类型:</td>
                        <td>
                            <input type="radio" id="javaClassType" name="_type" value="javaClass"
                                   onclick="selectServiceTaskType(this)" checked/>Java类
                            <input type="radio" id="expressionType" name="_type" value="expression"
                                   onclick="selectServiceTaskType(this)"/>表达式
                            <input type="radio" id="delegateExpressionType" name="_type" value="delegateExpression"
                                   onclick="selectServiceTaskType(this)"/>委托表达式
                        </td>
                    </tr>
                    <tr id="serviceClassTr">
                        <td >服务类:</td>
                        <td>
                            <input type="text" id="serviceClass" name="serviceClass" value="" size="50"/>
                        </td>
                    </tr>
                    <tr id="expressionTr" style="display:none;">
                        <td >表达式:</td>
                        <td>
                            <input type="text" id="_expression" name="_expression" value="" size="50"/>
                        </td>
                    </tr>
                    <tr id="delegateExpressionTr" style="display:none;">
                        <td >委托表达式:</td>
                        <td>
                            <input type="text" id="delegateExpression" name="delegateExpression" value="" size="50"/>
                        </td>
                    </tr>
                    <tr>
                        <td>结果变量:</td>
                        <td>
                            <input type="text" id="resultVariable" name="resultVariable" value="" size="50"/>
                        </td>
                    </tr>
                    <tr>
                        <td>字段:</td>
                        <td>
                            <div id="task-Fields-panel">
                                <table id="task-Fields-list">
                                    <thead>
                                    <tr>
                                        <th field="id" hidden="true"></th>
                                        <th field="fieldName" width="100" align="middle" sortable="false" editor="{
										type:'validatebox',
										options:{
										required:true,
										validType:'length[1,100]'
									}}">字段名称
                                        </th>
                                        <th field="type" width="100" align="middle" sortable="false" editor="{
										type:'combobox',
										options:{
											editable:false,
											data:[{id:'string',text:'String',selected:true},{id:'expression',text:'Expression'}],
											valueField:'id',
											textField:'text'
									}}">类型
                                        </th>
                                        <th field="value" width="150" align="middle" sortable="false" editor="{
										type:'validatebox',
										options:{
										validType:'length[1,100]'
									}}">数值
                                        </th>
                                        <th field="action" width="80" align="middle" formatter="fieldsActionFormatter">
                                            操作
                                        </th>
                                    </tr>
                                    </thead>
                                </table>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td>文献资料:</td>
                        <td><textarea id="documentation" name="documentation" cols="50" rows="5"></textarea></td>
                    </tr>
                </table>
            </div>
            <div id="listeners" title="监听器" style="padding:5px;">
                <table id="task-listeners-list">
                    <thead>
                    <tr>
                        <th field="listenerImplimentation" width="200" align="middle" sortable="false">
                            监听器说明
                        </th>
                        <th field="type" width="70" align="middle" sortable="false">类型</th>
                        <th field="event" width="70" align="middle" sortable="false">事件</th>
                        <th field="fields" width="100" align="middle">字段</th>
                        <th field="action" width="100" align="middle" formatter="listenerActionBt">操作</th>
                    </tr>
                    </thead>
                </table>
            </div>
            <div id="multi-instance" title="多实例" class="properties-menu">

            </div>
        </div>
    </div>
</div>