<%
include("/page/tags/form_include.html"){}
%>
<form id="logHistoryModifyDataForm" method="post">
    <div class="fitem">
        <#InputFormTag name='model' title='模块' required='true' />
        <#InputFormTag name='namespace' title='namespace' required='true' />
    </div>
    <div class="fitem">
        <#InputFormTag name='pkey' title='主键' required='true' />
        <#InputFormTag name='version' title='版本' required='true' />
    </div>
    <div class="fitem">
        <div class="bigLabelDiv"><label>修改前内容:</label></div>
        <div class="bigContent">
            <textarea class="form_textarea " id="beforeData" name="beforeData" style="height: 30%"></textarea>
        </div>
    </div>
    <div class="fitem">
        <div class="bigLabelDiv"><label>修改后内容:</label></div>
        <div class="bigContent">
            <textarea class="form_textarea " id="data" name="data" style="height: 30%"></textarea>
        </div>
    </div>
    <div class="fitem">
        <div class="bigLabelDiv"><label>修改的内容:</label></div>
        <div class="bigContent">
            <textarea class="form_textarea " id="modifyData" name="modifyData" style="height: 30%"></textarea>
        </div>
    </div>
</form>

<script>
    var pkey = "${parameter.pkey}";
    var version = "${parameter.version}";

    $('#logHistoryModifyDataForm').form({
        onLoadSuccess: loadFormSuccess
    });
    $("#logHistoryModifyDataForm").form('load',
        '${basePath}ms/logOperatorMain/getLogHistoryData?pkey=' + pkey + '&version=' + version);

    function loadFormSuccess(info) {
        if (isView) {
            renderView('logHistoryModifyDataForm');
        }
        $.ajax({
            url: '${basePath}ms/logOperatorMain/getLogHistoryData?pkey=' + pkey + '&version=' + (version - 1),
            dataType: 'json',
            type: 'POST',
            data: {},
            success: function (data) {
                $("#beforeData").val(data.data);
                var initialData = JSON.parse(data.data);
                var updateData = JSON.parse(info.data);
                var str = "";
                for (var key in initialData) {
                    for (var key2 in updateData) {
                        if (key === key2) {
                            if (JSON.stringify(initialData[key]) !== JSON.stringify(updateData[key])) {
                                if (key === 'transMap') {
                                    for (var key3 in initialData[key]) {
                                        if (JSON.stringify(initialData[key][key3]) !== JSON.stringify(updateData[key][key3])) {
                                            str += key + ":{ " + key3 + ": 由 " + JSON.stringify(initialData[key][key3]) + " 变为 " + JSON.stringify(updateData[key][key3]) + " }\n"
                                        }
                                    }
                                } else {
                                    str += key + ": 由 " + JSON.stringify(initialData[key]) + " 变为 " + JSON.stringify(updateData[key]) + "\n"
                                }
                            }
                        }
                    }
                }
                $("#modifyData").val(str)
            }
        })
    }
</script>