<%
include("/page/tags/form_include.html"){}
%>
<form id="logDetailForm" method="post">
    <div class="fitem">
        <#InputFormTag name='model' title='模块' required='true' />
        <#InputFormTag name='logId' title='主键' required='true' />
    </div>
    <div class="fitem">
        <#InputFormTag name='namespace' title='namespace' required='true' />
        <#InputFormTag id='userName' name='createUser' title='操作人' required='true' />
    </div>
    <div class="fitem">
        <#InputFormTag name='createTime' title='操作时间' required='true' />
        <#InputFormTag id='state' name='state' title='状态' required='true' />
    </div>
    <div class="fitem">
        <#InputFormTag id='type' name='type' title='类型' required='true' />
        <#InputFormTag name='url' title='请求地址' required='true' />
    </div>
    <div class="fitem">
        <#InputFormTag name='ip' title='ip' required='true' />
    </div>
    <div class="fitem">
        <div class="bigLabelDiv"><label>请求参数:</label></div>
        <div class="bigContent"><textarea
                class="form_textarea " id="reqParam" name="reqParam" style="height: 30%"></textarea>
        </div>
    </div>
    <div class="fitem">
        <div class="bigLabelDiv"><label>返回值:</label></div>
        <div class="bigContent"><textarea
                class="form_textarea " id="respBody" name="respBody" style="height: 30%"></textarea>
        </div>
    </div>

</form>

<div class="infoGroup">
    <legend>扩展参数</legend>
</div>
<div>
    <table id="extended_parameters" class="easyui-datagrid"
           url="${basePath}ms/logOperatorMain/getLoggerList?mainId=${parameter.logId}" rownumbers="true">
        <thead>
        <tr>
            <th field="model" width="17%" align="center">模块</th>
            <th field="namespace" width="17%" align="center">namespace</th>
            <th field="transMap.operatorTypeName" width="16%" align="center">类型</th>
            <th field="pkey" width="16%" align="center">主键</th>
            <th field="version" width="16%" align="center">版本</th>
            <th field="opera" width="16%" data-options="formatter:opera" align="center">操作</th>
        </tr>
        </thead>
    </table>
</div>
<div id="logDialog" class="easyui-dialog" title="回退节点"
     data-options="iconCls:'icon-save'" closed="true"
     style="width: 80%; height: 90%; padding: 10px" buttons="#dlg-buttons">
</div>

<div id="dlg-buttons">
    <a href="#" class="easyui-linkbutton" onclick="closeDialogExtParamDetail()">返回</a>
</div>

<script>
    var logId = "${parameter.logId}"


    $('#logDetailForm').form({
        onLoadSuccess: loadFormSuccess
    });
    $('#logDetailForm').form('load', '${basePath}ms/logOperatorMain/getLogger?logId=' + logId);

    function loadFormSuccess(info) {
        $("#createUser").val(info.transMap.createUserUserName);
        $("#state").val(info.transMap.stateName);
        $("#type").val(info.transMap.typeName);
        if (isView) {
            renderView('logDetailForm');
            $('#subBtn').hide();
        }
    }

    // 打开dialog
    function openDialogExtParamDetail(url, title) {
        $('#logDialog').load(url, function () {
            $('#logDialog').dialog('open').dialog('setTitle', title);
            $.parser.parse($('#logDialog'));
        });
    }

    function opera(val, row, index) {
        if (row.operatorType != 2){
            return '<a href="#" class="easyui-linkbutton" style="color:white !important"' +
                'onclick=logView("' + row.pkey + '",' + row.version + ','+row.operatorType +')>查看</a>';
        }else{
            return  '<a href="#">已删除</a>'
        }
    }

    function logView(pkey, version,operatorType) {
        if (operatorType != 1 || (operatorType == 1&&version==1)) {
            openDialogExtParamDetail(
                '${basePath}/b/page-ms-logger/logView?isView=true&pkey=' + pkey + '&version=' + version, '查看');
        } else {
            openDialogExtParamDetail(
                '${basePath}/b/page-ms-logger/logModifyView?isView=true&pkey=' + pkey + '&version=' + version, '查看');
        }

    }

    // 关闭dialog
    function closeDialogExtParamDetail() {
        $('#logDialog').dialog('close');
    }

</script>
